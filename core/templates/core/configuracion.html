{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl">
    
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Configuraci√≥n del Monitor</h1>
        <p class="text-gray-600">Define qu√© debe buscar el "cerebro" h√≠brido (Noticias y Medidas).</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-white rounded-xl shadow-md border-t-4 border-blue-600 overflow-hidden">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-2 flex items-center text-gray-800">
                        <i class="fas fa-brain text-blue-600 mr-2"></i> 1. Conceptos de Inter√©s
                    </h2>
                    <p class="text-sm text-gray-500 mb-6">
                        Aqu√≠ alimentas al monitor. Puedes escribir frases manuales o pedirle a la IA que busque semejanzas.
                    </p>
                    
                    <div class="flex flex-col md:flex-row gap-3 mb-4">
                        <div class="relative flex-grow">
                            <input type="text" id="tag_input" 
                                class="w-full p-3 pl-4 pr-12 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                placeholder="Escribe una frase y presiona ENTER (Ej: Energ√≠a Renovable)">
                            <button onclick="addManualTagFromInput()" class="absolute right-2 top-2.5 text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-plus-circle fa-lg"></i>
                            </button>
                        </div>

                        <button onclick="generateKeywordsAI()" id="btn-ai-generate" class="md:w-auto bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-semibold px-4 py-3 rounded-lg border border-indigo-200 transition flex items-center justify-center whitespace-nowrap">
                            <i class="fas fa-magic mr-2"></i> Sugerir con IA
                        </button>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 min-h-[100px]">
                        <p class="text-xs text-blue-400 font-bold uppercase mb-2 tracking-wide">Conceptos Activos (El monitor buscar√° esto):</p>
                        
                        <div id="tags_visual_container" class="flex flex-wrap gap-2">
                            <span class="text-gray-400 text-sm italic py-2" id="empty-tags-msg">No hay conceptos definidos. El monitor est√° ciego.</span>
                        </div>
                    </div>

                    <input type="hidden" id="final_keywords_string" value="{{ preset.keywords|default:'' }}">

                    <div class="mt-6 flex justify-end">
                        <button onclick="saveProfile()" id="btn-save-profile" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center">
                            <i class="fas fa-save mr-2"></i> Guardar Perfil de B√∫squeda
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold mb-4 text-gray-800">Ajuste Fino del Motor</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">M√©todo de B√∫squeda</label>
                        <select id="search_method" class="w-full p-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="hybrid" {% if preset.search_method == 'hybrid' %}selected{% endif %}>H√≠brido (Texto + Semejanzas IA)</option>
                            <option value="semantic" {% if preset.search_method == 'semantic' %}selected{% endif %}>Solo Semejanzas (IA)</option>
                            <option value="keyword" {% if preset.search_method == 'keyword' %}selected{% endif %}>Exacto (Solo Palabras)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">"H√≠brido" es lo recomendado en tu plan.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Sensibilidad: <span class="text-blue-600 font-bold" id="val_threshold_display">{{ preset.threshold|default:15 }}%</span>
                        </label>
                        <input type="range" id="threshold" min="0" max="100" value="{{ preset.threshold|default:15 }}" 
                            oninput="document.getElementById('val_threshold_display').innerText = this.value + '%'"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            
            <div class="bg-white rounded-xl shadow-md border-t-4 border-red-500 p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                    <i class="fas fa-bell text-red-500 mr-2"></i> Alertas (Webhook)
                </h2>
                <p class="text-xs text-gray-500 mb-3">Pega aqu√≠ el link de Discord o Slack para recibir notificaciones.</p>
                
                <div class="space-y-3">
                    <input type="url" id="webhook_url" value="{{ user_webhook }}" placeholder="https://discord.com/api/webhooks/..." 
                        class="w-full p-2 text-sm border border-gray-300 rounded outline-none focus:ring-2 focus:ring-red-200">
                    
                    <button onclick="saveWebhook()" id="btn-save-webhook" class="w-full bg-red-50 hover:bg-red-100 text-red-700 font-semibold py-2 rounded-lg border border-red-200 transition text-sm">
                        Guardar Webhook
                    </button>
                </div>
            </div>

            <div class="bg-gray-100 rounded-xl p-4 text-sm text-gray-600">
                <h3 class="font-bold mb-2"><i class="fas fa-info-circle"></i> ¬øC√≥mo funciona?</h3>
                <ul class="list-disc pl-4 space-y-1">
                    <li><b>Manual:</b> Busca exactamente lo que escribes.</li>
                    <li><b>IA:</b> Expande tu b√∫squeda a temas relacionados.</li>
                    <li><b>H√≠brido:</b> Usa ambas estrategias para encontrar noticias y medidas legislativas (SUTRA).</li>
                </ul>
            </div>

        </div>
    </div>
</div>

<script>
// --- ESTADO GLOBAL DE LAS ETIQUETAS ---
let keywordsList = [];

// AL CARGAR LA P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
    // 1. Cargar lo que ya estaba guardado en BD
    const savedString = document.getElementById('final_keywords_string').value;
    if (savedString) {
        savedString.split(',').forEach(word => {
            if(word.trim()) addTagData(word.trim());
        });
    }
    renderTags(); 

    // 2. Escuchar Enter en el input manual
    document.getElementById('tag_input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addManualTagFromInput();
        }
    });
});

// --- L√ìGICA DE GESTI√ìN DE ETIQUETAS (EL POOL) ---

function addManualTagFromInput() {
    const input = document.getElementById('tag_input');
    const val = input.value.trim();
    if (val) {
        addTagData(val); // A√±adir al sistema
        input.value = ''; // Limpiar input
        renderTags(); // Actualizar visualmente
    }
}

function addTagData(text) {
    if (!text) return;
    // Limpiamos comas para evitar errores en el string final
    const cleanText = text.replace(/,/g, ''); 
    // Evitamos duplicados
    if (!keywordsList.includes(cleanText)) {
        keywordsList.push(cleanText);
    }
    updateHiddenInput();
}

function removeTag(text) {
    keywordsList = keywordsList.filter(t => t !== text);
    renderTags();
    updateHiddenInput();
}

function updateHiddenInput() {
    // Esto actualiza el campo invisible que se enviar√° al servidor
    document.getElementById('final_keywords_string').value = keywordsList.join(',');
}

function renderTags() {
    const container = document.getElementById('tags_visual_container');
    const emptyMsg = document.getElementById('empty-tags-msg');
    
    container.innerHTML = ''; // Limpiar visualmente

    if (keywordsList.length === 0) {
        container.appendChild(emptyMsg);
        emptyMsg.style.display = 'block';
    } else {
        emptyMsg.style.display = 'none';

        keywordsList.forEach(word => {
            // Creamos la "cajita" visual (Chip)
            const tagEl = document.createElement('div');
            tagEl.className = 'inline-flex items-center bg-white border border-blue-200 text-blue-800 px-3 py-1.5 rounded-lg text-sm font-medium shadow-sm transition hover:shadow-md animate-fade-in';
            tagEl.innerHTML = `
                <span class="mr-2">${word}</span>
                <button onclick="removeTag('${word}')" class="text-blue-300 hover:text-red-500 focus:outline-none transition">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            container.appendChild(tagEl);
        });
    }
}

// --- GENERADOR IA (SIMULADO PARA INTERFAZ) ---
async function generateKeywordsAI() {
    const btn = document.getElementById('btn-ai-generate');
    const input = document.getElementById('tag_input');
    
    // Si el usuario escribi√≥ algo en el input pero no dio enter, √∫salo de contexto
    let context = input.value || keywordsList.join(" ");

    if (!context) {
        alert("Escribe al menos un tema manual para que la IA sepa qu√© buscar.");
        return;
    }

    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Pensando...';

    // AQU√ç CONECTAREMOS CON EL BACKEND REAL M√ÅS ADELANTE
    // Por ahora simulamos que la IA encuentra semejanzas basadas en tu contexto
    setTimeout(() => {
        // Simulamos respuesta de IA
        const suggestions = ["Energ√≠a Distribuida", "Infraestructura Cr√≠tica", "Permisos", "Fiscalizaci√≥n"];
        
        let added = 0;
        suggestions.forEach(s => {
            if(!keywordsList.includes(s)) {
                addTagData(s);
                added++;
            }
        });

        renderTags();
        
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if(added > 0) {
            alert(`üí° La IA encontr√≥ ${added} conceptos semejantes y los a√±adi√≥ a la lista.`);
        }
    }, 1000);
}

// --- GUARDAR DATOS (SEPARADO) ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 1. Guardar PERFIL (Keywords, Metodo, Threshold)
async function saveProfile() {
    const btn = document.getElementById('btn-save-profile');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';

    const payload = {
        action: 'save_profile',
        topics: document.getElementById('final_keywords_string').value,
        search_method: document.getElementById('search_method').value,
        threshold: document.getElementById('threshold').value
    };

    try {
        await sendData(payload);
        btn.innerHTML = '<i class="fas fa-check mr-2"></i> ¬°Perfil Actualizado!';
        btn.classList.add('bg-green-600');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-green-600');
            btn.disabled = false;
        }, 2000);
    } catch (e) {
        alert("Error: " + e);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// 2. Guardar WEBHOOK (Solo)
async function saveWebhook() {
    const btn = document.getElementById('btn-save-webhook');
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = 'Guardando...';

    const payload = {
        action: 'save_webhook',
        webhook: document.getElementById('webhook_url').value
    };

    try {
        await sendData(payload);
        btn.innerHTML = '¬°Guardado!';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    } catch (e) {
        alert("Error: " + e);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Funci√≥n auxiliar para enviar al servidor
async function sendData(payload) {
    // Usamos la misma vista, pero le pasamos los datos espec√≠ficos
    // Nota: Para que funcione 100% con tu backend actual, enviamos todo junto si es necesario,
    // pero aqu√≠ lo separo l√≥gicamente. El backend 'views.py' que hicimos antes acepta el JSON gen√©rico.
    
    const response = await fetch('/configuracion/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.message);
    return data;
}
</script>
{% endblock %}