{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl">
    
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Configuraci√≥n del Monitor</h1>
        <p class="text-gray-600">Define qu√© debe buscar el "cerebro" h√≠brido (Noticias y Medidas).</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-white rounded-xl shadow-md border-t-4 border-blue-600 overflow-hidden">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-2 flex items-center text-gray-800">
                        <i class="fas fa-brain text-blue-600 mr-2"></i> 1. Conceptos de Inter√©s
                    </h2>
                    <p class="text-sm text-gray-500 mb-6">
                        Aqu√≠ alimentas al monitor. Puedes escribir frases manuales o pedirle a la IA que busque semejanzas.
                    </p>
                    
                    <div class="flex flex-col md:flex-row gap-3 mb-4">
                        <div class="relative flex-grow">
                            <input type="text" id="tag_input" 
                                class="w-full p-3 pl-4 pr-12 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                placeholder="Escribe una frase y presiona ENTER (Ej: Energ√≠a Renovable)">
                            <button type="button" onclick="addManualTagFromInput()" class="absolute right-2 top-2.5 text-blue-600 hover:text-blue-800 p-1">
                                <i class="fas fa-plus-circle fa-lg"></i>
                            </button>
                        </div>

                        <button type="button" onclick="generateKeywordsAI()" id="btn-ai-generate" class="md:w-auto bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-semibold px-4 py-3 rounded-lg border border-indigo-200 transition flex items-center justify-center whitespace-nowrap">
                            <i class="fas fa-magic mr-2"></i> Sugerir con IA
                        </button>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="text-xs text-blue-400 font-bold uppercase mb-2 tracking-wide">Conceptos Activos (El monitor buscar√° esto):</p>
                        
                        <div id="tags_visual_container" class="flex flex-wrap gap-2 min-h-[300px] border-2 border-gray-300 overflow-y-auto p-3 w-full">
                            <!-- tags render here -->
                        </div>
                    </div>

                    <input type="hidden" id="final_keywords_string" value="{{ preset.keywords|default:'' }}">

                    <div class="mt-6 flex justify-end">
                        <button onclick="saveProfile()" id="btn-save-profile" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center">
                            <i class="fas fa-save mr-2"></i> Guardar Perfil de B√∫squeda
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold mb-4 text-gray-800">Ajuste Fino del Motor</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">M√©todo de B√∫squeda</label>
                        <select id="search_method" class="w-full p-2 bg-gray-50 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="hybrid" {% if preset.search_method == 'hybrid' %}selected{% endif %}>H√≠brido (Texto + Semejanzas IA)</option>
                            <option value="semantic" {% if preset.search_method == 'semantic' %}selected{% endif %}>Solo Semejanzas (IA)</option>
                            <option value="keyword" {% if preset.search_method == 'keyword' %}selected{% endif %}>Exacto (Solo Palabras)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">"H√≠brido" es lo recomendado en tu plan.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Sensibilidad: <span class="text-blue-600 font-bold" id="val_threshold_display">{{ preset.threshold|default:15 }}%</span>
                        </label>
                        <input type="range" id="threshold" min="0" max="100" value="{{ preset.threshold|default:15 }}" 
                            oninput="document.getElementById('val_threshold_display').innerText = this.value + '%'"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            
            <div class="bg-white rounded-xl shadow-md border-t-4 border-red-500 p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                    <i class="fas fa-bell text-red-500 mr-2"></i> Alertas (Webhook)
                </h2>
                <p class="text-xs text-gray-500 mb-3">Pega aqu√≠ el link de Discord o Slack para recibir notificaciones.</p>
                
                <div class="space-y-3">
                    <input type="url" id="webhook_url" value="{{ user_webhook }}" placeholder="https://discord.com/api/webhooks/..." 
                        class="w-full p-2 text-sm border border-gray-300 rounded outline-none focus:ring-2 focus:ring-red-200">
                    
                    <button onclick="saveWebhook()" id="btn-save-webhook" class="w-full bg-red-50 hover:bg-red-100 text-red-700 font-semibold py-2 rounded-lg border border-red-200 transition text-sm">
                        Guardar Webhook
                    </button>
                </div>
            </div>

            <div class="bg-gray-100 rounded-xl p-4 text-sm text-gray-600">
                <h3 class="font-bold mb-2"><i class="fas fa-info-circle"></i> ¬øC√≥mo funciona?</h3>
                <ul class="list-disc pl-4 space-y-1">
                    <li><b>Manual:</b> Busca exactamente lo que escribes.</li>
                    <li><b>IA:</b> Expande tu b√∫squeda a temas relacionados.</li>
                    <li><b>H√≠brido:</b> Usa ambas estrategias para encontrar noticias y medidas legislativas (SUTRA).</li>
                </ul>
            </div>

        </div>
    </div>
</div>

<script>
// --- ESTADO GLOBAL DE LAS ETIQUETAS ---
// Hacerlo persistente en `window` para evitar reinicios accidentales
window.keywordsList = window.keywordsList || [];

// AL CARGAR LA P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
    // 1. Cargar lo que ya estaba guardado en BD
    const savedString = document.getElementById('final_keywords_string').value;
    if (savedString) {
        savedString.split(',').forEach(word => {
            const w = (word || '').trim();
            if (w) addTagData(w); // usa addTagData que hace push sobre window.keywordsList
        });
    }
    renderTags(); 

    // 2. Escuchar Enter en el input manual
    document.getElementById('tag_input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addManualTagFromInput();
        }
    });
});

// --- L√ìGICA DE GESTI√ìN DE ETIQUETAS (EL POOL) ---

function addManualTagFromInput() {
    const input = document.getElementById('tag_input');
    const val = (input.value || '').trim();
    if (val) {
        // Agregar sin reiniciar el array
        addTagData(val);
        input.value = '';
        renderTags();
    }
}

function addTagData(text) {
    if (!text) return;
    const cleanText = String(text).replace(/,/g, '').trim();
    if (!cleanText) return;
    // Usar el array global persistente
    if (!window.keywordsList.includes(cleanText)) {
        window.keywordsList.push(cleanText);
    }
    updateHiddenInput();
}

function removeTag(text) {
    window.keywordsList = window.keywordsList.filter(t => t !== text);
    renderTags();
    updateHiddenInput();
}

function updateHiddenInput() {
    // Esto actualiza el campo invisible que se enviar√° al servidor
    document.getElementById('final_keywords_string').value = (window.keywordsList || []).join(',');
}

function renderTags() {
    const container = document.getElementById('tags_visual_container');
    const list = window.keywordsList || [];
    container.innerHTML = '';

    if (list.length === 0) {
        const msg = document.createElement('span');
        msg.className = 'text-gray-400 text-sm italic py-2';
        msg.id = 'empty-tags-msg';
        msg.innerText = 'No hay conceptos definidos. El monitor est√° ciego.';
        container.appendChild(msg);
        return;
    }

    list.forEach(word => {
        const tagEl = document.createElement('div');
        tagEl.className = 'inline-flex items-center bg-white border border-blue-200 text-blue-800 px-3 py-1.5 rounded-lg text-sm font-medium shadow-sm transition hover:shadow-md';
        const span = document.createElement('span');
        span.className = 'mr-2';
        span.innerText = word;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'text-blue-300 hover:text-red-500 focus:outline-none transition';
        btn.innerHTML = '<i class="fas fa-times-circle"></i>';
        btn.addEventListener('click', () => removeTag(word));
        tagEl.appendChild(span);
        tagEl.appendChild(btn);
        container.appendChild(tagEl);
    });
}

// --- GENERADOR IA (LLAMA AL BACKEND MOCK) ---
async function generateKeywordsAI() {
    const btn = document.getElementById('btn-ai-generate');
    const input = document.getElementById('tag_input');
    let context = input.value || (window.keywordsList || []).join(' ');

    if (!context) {
        alert('Escribe al menos un tema manual para que la IA sepa qu√© buscar.');
        return;
    }

    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Consultando IA...';

    try {
        const resp = await fetch('/api/generate-keywords/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ topics: context })
        });

        if (!resp.ok) {
            throw new Error('Respuesta no OK del servidor');
        }

        const data = await resp.json();
        const suggestions = Array.isArray(data.keywords) ? data.keywords : (Array.isArray(data.results) ? data.results : []);

        let added = 0;
        suggestions.forEach(s => {
            const clean = String(s).trim();
            if (clean && !(window.keywordsList || []).includes(clean)) {
                addTagData(clean);
                added++;
            }
        });

        renderTags();

        if (added > 0) {
            alert(`üí° La IA a√±adi√≥ ${added} conceptos a la lista.`);
        } else {
            alert('La IA no encontr√≥ conceptos nuevos.');
        }

    } catch (e) {
        console.error('Error llamando a IA:', e);
        alert('Error conectando con la IA. Intenta de nuevo.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// --- GUARDAR DATOS (SEPARADO) ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 1. Guardar PERFIL (Keywords, Metodo, Threshold)
async function saveProfile() {
    const btn = document.getElementById('btn-save-profile');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';

    const payload = {
        keywords: document.getElementById('final_keywords_string').value,
        search_method: document.getElementById('search_method').value,
        threshold: document.getElementById('threshold').value
    };

    try {
        const resp = await fetch('/api/save-profile/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error('Error guardando perfil');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Error servidor');

        btn.innerHTML = '<i class="fas fa-check mr-2"></i> ¬°Perfil Actualizado!';
        btn.classList.add('bg-green-600');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-green-600');
            btn.disabled = false;
        }, 1500);
    } catch (e) {
        alert('Error guardando perfil: ' + e.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// 2. Guardar WEBHOOK (Solo)
async function saveWebhook() {
    const btn = document.getElementById('btn-save-webhook');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Guardando...';

    const payload = { webhook: document.getElementById('webhook_url').value };

    try {
        const resp = await fetch('/api/save-webhook/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });

        if (!resp.ok) throw new Error('Error guardando webhook');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Error servidor');

        btn.innerHTML = '¬°Guardado!';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1200);
    } catch (e) {
        alert('Error guardando webhook: ' + e.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Funci√≥n auxiliar para enviar al servidor
async function sendData(payload) {
    // Legacy helper left for compatibility. Prefer using specific endpoints in saveProfile/saveWebhook.
    const response = await fetch('/configuracion/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Error desconocido');
    return data;
}
</script>
{% endblock %}